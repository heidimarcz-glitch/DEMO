<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sober Sight - See the life you're building</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,300;0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #748eff 0%, #a581ff 100%);
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: -200px;
            right: -200px;
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(205, 226, 255, 0.3) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 0;
        }

        body::after {
            content: '';
            position: fixed;
            bottom: -150px;
            left: -150px;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(223, 207, 238, 0.3) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 6em;
            margin-bottom: 0px;
            text-shadow: 3px 3px 8px rgba(0,0,0,0.3);
            font-weight: 600;
        }

        .tagline {
            font-size: 1.3em;
            font-style: italic;
            opacity: 0.95;
            font-weight: 300;
            margin-top: 0px;
            margin-bottom: 20px;
        }

        .description {
            font-size: 1.05em;
            opacity: 0.95;
            font-weight: 300;
            line-height: 1.6;
            max-width: 700px;
            margin: 0 auto;
        }

        .categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .category-card {
            background: white;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
            overflow: hidden;
        }

        .category-card::before {
            content: '';
            position: absolute;
            top: -50px;
            right: -50px;
            width: 120px;
            height: 120px;
            background: radial-gradient(circle, rgba(116, 142, 255, 0.1) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
        }

        .category-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .category-card h3 {
            color: #007eff;
            margin-bottom: 8px;
            font-size: 1.1em;
            position: relative;
            z-index: 1;
        }

        .category-card .photo-count {
            color: #303030;
            font-size: 0.9em;
            position: relative;
            z-index: 1;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: block;
        }

        .share-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1001;
            overflow-y: auto;
        }

        .share-modal.active {
            display: block;
        }

        .share-modal-content {
            max-width: 600px;
            margin: 60px auto;
            background: white;
            border-radius: 24px;
            padding: 30px;
            position: relative;
        }

        .share-preview {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .share-caption-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #cde2ff;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 1em;
            font-family: 'Poppins', sans-serif;
            min-height: 80px;
            resize: vertical;
        }

        .share-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-cancel {
            background: #f0f0f0;
            color: #303030;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1em;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
        }

        .btn-cancel:hover {
            background: #e0e0e0;
        }

        .btn-share {
            background: #00c4ff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1em;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
        }

        .btn-share:hover {
            background: #00a8d6;
        }

        .modal-content {
            max-width: 900px;
            margin: 40px auto;
            background: white;
            border-radius: 24px;
            padding: 30px;
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: #999;
            line-height: 1;
            transition: color 0.2s;
        }

        .close-btn:hover {
            color: #303030;
        }

        .modal-header {
            margin-bottom: 25px;
        }

        .modal-header h2 {
            color: #007eff;
            margin-bottom: 10px;
        }

        .upload-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #cde2ff;
            border-radius: 16px;
        }

        .upload-btn {
            background: #00c4ff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1em;
            margin-bottom: 10px;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            transition: background 0.3s, transform 0.2s;
        }

        .upload-btn:hover {
            background: #00a8d6;
            transform: translateY(-1px);
        }

        .file-input {
            display: none;
        }

        .caption-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 12px;
            margin-top: 10px;
            font-size: 1em;
            font-family: 'Poppins', sans-serif;
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .photo-item {
            position: relative;
            border-radius: 16px;
            overflow: hidden;
            background: #f0f0f0;
            aspect-ratio: 1;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            transition: transform 0.2s;
        }

        .photo-item:hover {
            transform: scale(1.02);
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-caption {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px;
            font-size: 0.85em;
        }

        .photo-date {
            font-size: 0.75em;
            opacity: 0.8;
        }

        .delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255,255,255,0.9);
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            color: #303030;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .share-btn {
            position: absolute;
            top: 8px;
            right: 45px;
            background: rgba(0, 196, 255, 0.95);
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            color: white;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .share-btn:hover {
            background: rgba(0, 168, 214, 0.95);
        }

        .photo-item:hover .share-btn {
            opacity: 1;
        }

        .photo-item:hover .delete-btn {
            opacity: 1;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #303030;
            opacity: 0.7;
        }

        .preview-section {
            margin-top: 15px;
        }

        .preview-image {
            max-width: 200px;
            border-radius: 12px;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 3.5em;
            }
            
            .categories {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                margin: 20px;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sober Sight</h1>
            <p class="tagline">See the life you're building</p>
            <p class="description">Uploading photos to your Sober Sidekick vision board helps you see your progress, stay focused, and hold onto hope. It's a simple way to remind yourself of the life you're building‚Äîespecially on the tough days.</p>
        </div>

        <div class="categories" id="categories"></div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal()">&times;</button>
            <div class="modal-header">
                <h2 id="modalTitle"></h2>
            </div>
            
            <div class="upload-section">
                <input type="file" id="fileInput" class="file-input" accept="image/*" onchange="handleFileSelect(event)">
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    üì∏ Add Photo
                </button>
                <div class="preview-section" id="previewSection" style="display: none;">
                    <img id="previewImage" class="preview-image" alt="Preview">
                    <input type="text" id="captionInput" class="caption-input" placeholder="Add a caption (optional)...">
                    <button class="upload-btn" onclick="savePhoto()" style="margin-top: 10px;">Save Photo</button>
                </div>
            </div>

            <div class="gallery" id="gallery"></div>
        </div>
    </div>

    <div class="share-modal" id="shareModal">
        <div class="share-modal-content">
            <button class="close-btn" onclick="closeShareModal()">&times;</button>
            <h2 style="color: #007eff; margin-bottom: 20px;">Share to Feed</h2>
            <img id="sharePreviewImage" class="share-preview" alt="Photo to share">
            <textarea id="shareCaptionInput" class="share-caption-input" placeholder="Add a caption to share with the community..."></textarea>
            <p style="color: #666; font-size: 0.9em; margin-bottom: 20px;">This photo will be visible to all community members.</p>
            <div class="share-actions">
                <button class="btn-cancel" onclick="closeShareModal()">Cancel</button>
                <button class="btn-share" onclick="confirmShare()">Share to Feed</button>
            </div>
        </div>
    </div>

    <script>
        const categories = [
            { id: 'why-sober', name: 'Why I Stay Sober', emoji: 'üí™' },
            { id: 'hard-days', name: 'Hard Days & Proof I Survived', emoji: 'üåü' },
            { id: 'working-toward', name: 'What I\'m Working Toward', emoji: 'üéØ' },
            { id: 'support', name: 'People & Places That Help', emoji: '‚ù§Ô∏è' }
        ];

        let currentCategory = null;
        let previewImageData = null;

        async function initApp() {
            // Check if storage is available
            if (!window.storage) {
                document.getElementById('categories').innerHTML = `
                    <div style="background: white; padding: 20px; border-radius: 12px; text-align: center;">
                        <p style="color: #e74c3c; margin-bottom: 10px;">‚ö†Ô∏è Storage is not available</p>
                        <p style="color: #666;">Please make sure you're viewing this in Claude's artifact viewer.</p>
                    </div>
                `;
                return;
            }
            
            await renderCategories();
        }

        async function renderCategories() {
            const container = document.getElementById('categories');
            container.innerHTML = '';

            for (const category of categories) {
                const photos = await getPhotos(category.id);
                const card = document.createElement('div');
                card.className = 'category-card';
                card.onclick = () => openCategory(category);
                card.innerHTML = `
                    <h3>${category.emoji} ${category.name}</h3>
                    <p class="photo-count">${photos.length} photo${photos.length !== 1 ? 's' : ''}</p>
                `;
                container.appendChild(card);
            }
        }

        async function getPhotos(categoryId) {
            if (!window.storage) {
                return [];
            }

            try {
                const indexKey = `index:${categoryId}`;
                let indexResult;
                
                try {
                    indexResult = await window.storage.get(indexKey);
                } catch (e) {
                    // Key doesn't exist yet - this is normal for new categories
                    return [];
                }
                
                if (!indexResult || !indexResult.value) {
                    return [];
                }
                
                const photoIds = JSON.parse(indexResult.value);
                const photos = [];
                
                for (const photoId of photoIds) {
                    try {
                        const data = await window.storage.get(photoId);
                        if (data && data.value) {
                            photos.push(JSON.parse(data.value));
                        }
                    } catch (e) {
                        // Photo might have been deleted, skip it
                        continue;
                    }
                }
                
                return photos.sort((a, b) => b.timestamp - a.timestamp);
            } catch (e) {
                console.error('Error getting photos:', e);
                return [];
            }
        }

        async function openCategory(category) {
            currentCategory = category;
            document.getElementById('modalTitle').textContent = `${category.emoji} ${category.name}`;
            document.getElementById('modal').classList.add('active');
            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('fileInput').value = '';
            previewImageData = null;
            await renderGallery();
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            currentCategory = null;
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                previewImageData = e.target.result;
                document.getElementById('previewImage').src = previewImageData;
                document.getElementById('previewSection').style.display = 'block';
                document.getElementById('captionInput').value = '';
                document.getElementById('captionInput').focus();
            };
            reader.readAsDataURL(file);
        }

        async function savePhoto() {
            if (!previewImageData || !currentCategory) return;

            const caption = document.getElementById('captionInput').value;
            const timestamp = Date.now();
            const photoId = `photo:${currentCategory.id}:${timestamp}`;

            const photoData = {
                id: photoId,
                categoryId: currentCategory.id,
                imageData: previewImageData,
                caption: caption,
                timestamp: timestamp,
                date: new Date().toLocaleDateString()
            };

            try {
                // Save the photo
                await window.storage.set(photoId, JSON.stringify(photoData));
                
                // Update the index
                const indexKey = `index:${currentCategory.id}`;
                let photoIds = [];
                
                try {
                    const indexResult = await window.storage.get(indexKey);
                    if (indexResult && indexResult.value) {
                        photoIds = JSON.parse(indexResult.value);
                    }
                } catch (e) {
                    // Index doesn't exist yet, that's fine
                }
                
                photoIds.push(photoId);
                await window.storage.set(indexKey, JSON.stringify(photoIds));
                
                document.getElementById('previewSection').style.display = 'none';
                document.getElementById('fileInput').value = '';
                previewImageData = null;
                
                await renderGallery();
                await renderCategories();
            } catch (e) {
                alert('Error saving photo. Please try again.');
                console.error('Error saving photo:', e);
            }
        }

        async function renderGallery() {
            const gallery = document.getElementById('gallery');
            const photos = await getPhotos(currentCategory.id);

            if (photos.length === 0) {
                gallery.innerHTML = '<div class="empty-state">No photos yet. Add your first one!</div>';
                return;
            }

            gallery.innerHTML = '';
            photos.forEach(photo => {
                const item = document.createElement('div');
                item.className = 'photo-item';
                item.innerHTML = `
                    <img src="${photo.imageData}" alt="${photo.caption || 'Photo'}">
                    ${photo.caption ? `<div class="photo-caption">
                        ${photo.caption}
                        <div class="photo-date">${photo.date}</div>
                    </div>` : `<div class="photo-caption">
                        <div class="photo-date">${photo.date}</div>
                    </div>`}
                    <button class="share-btn" onclick="openShareModal('${photo.id}')" title="Share to forum">üì§ Share</button>
                    <button class="delete-btn" onclick="deletePhoto('${photo.id}')" title="Delete photo">√ó</button>
                `;
                gallery.appendChild(item);
            });
        }

        let photoToShare = null;

        async function openShareModal(photoId) {
            try {
                const data = await window.storage.get(photoId);
                if (data && data.value) {
                    photoToShare = JSON.parse(data.value);
                    document.getElementById('sharePreviewImage').src = photoToShare.imageData;
                    document.getElementById('shareCaptionInput').value = photoToShare.caption || '';
                    document.getElementById('shareModal').classList.add('active');
                }
            } catch (e) {
                console.error('Error loading photo for sharing:', e);
            }
        }

        function closeShareModal() {
            document.getElementById('shareModal').classList.remove('active');
            photoToShare = null;
        }

        async function confirmShare() {
            if (!photoToShare) return;

            const shareCaption = document.getElementById('shareCaptionInput').value;
            
            // In a real implementation, this would send to your backend/forum
            // For now, we'll just show a success message
            alert(`Photo shared to feed!\n\nCaption: ${shareCaption || '(no caption)'}\n\nIn the full app, this would post to the Sober Sidekick community feed.`);
            
            closeShareModal();
        }

        // Close share modal when clicking outside
        document.getElementById('shareModal').addEventListener('click', (e) => {
            if (e.target.id === 'shareModal') {
                closeShareModal();
            }
        });

        async function deletePhoto(photoId) {
            if (!confirm('Are you sure you want to delete this photo?')) return;

            try {
                // Delete the photo
                await window.storage.delete(photoId);
                
                // Update the index
                const indexKey = `index:${currentCategory.id}`;
                try {
                    const indexResult = await window.storage.get(indexKey);
                    if (indexResult && indexResult.value) {
                        let photoIds = JSON.parse(indexResult.value);
                        photoIds = photoIds.filter(id => id !== photoId);
                        await window.storage.set(indexKey, JSON.stringify(photoIds));
                    }
                } catch (e) {
                    console.error('Error updating index:', e);
                }
                
                await renderGallery();
                await renderCategories();
            } catch (e) {
                alert('Error deleting photo. Please try again.');
                console.error('Error deleting photo:', e);
            }
        }

        // Close modal when clicking outside
        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target.id === 'modal') {
                closeModal();
            }
        });

        // Initialize app
        initApp();
    </script>
</body>
</html>
